{
  "variables": {
    "k3os_version": "v0.2.0",
    "iso_url": "https://github.com/rancher/k3os/releases/download/v0.2.0/k3os-amd64.iso"
  },
  "builders": [
    {
      "type": "openstack",
      "name": "rancheros",
      "flavor": "c1.c4r4",
      "image_name": "rancheros {{ timestamp }}",
      "source_image_filter": {
        "most_recent": true,
        "filters": {
          "name": "ubuntu-minimal-18.04-x86_64",
          "visibility": "protected",
          "owner": "94b566de52f9423fab80ceee8c0a4a23"
        }
      },
      "security_groups": [
        "default",
        "manage-travis-lp"
      ],
      "cloud": "docker-training",
      "ssh_username": "ubuntu",
      "floating_ip_network": "public-net",
      "metadata": {
        "project": "smartstart",
        "function": "frontend"
      }
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "./openstack.yaml",
      "destination": "/tmp/config.yaml"
    },
    {
      "type": "file",
      "source": "./install.sh",
      "destination": "/tmp/"
    },
    {
      "type": "shell",
      "inline": [
        "sudo apt-get update -y",
        "sudo apt-get install -y dosfstools parted",
        "sudo bash -x /tmp/install.sh --takeover --debug --tty ttyS0 --config /tmp/config.yaml --no-format $(findmnt / -o SOURCE -n) \"{{user `iso_url`}}\""
      ]
    },
    {
      "type": "shell",
      "inline": [
        "set -x; sudo systemd-run --on-active=3 --timer-property=AccuracySec=100ms sudo systemctl reboot --force --force; sync; echo Rebooting"
      ],
      "pause_after": "3m"
    }
  ]
}
